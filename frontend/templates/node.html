<div style="display:flex;flex-direction: row;">
	<div style="flex-direction: column;">

		<!-- List Nodes -->
		<section class="mt-6 mx-6 w-100 bg-base-100 p-4 rounded-box shadow-md">
			<h2 class="text-xl text-center font-semibold mb-2">âš¡ï¸ Lightning nodes âš¡ï¸</h2>
			<table class="table table-zebra table-sm table-bordered">
				<thead>
					<th scope="col" id="id">Id</th>
					<th scope="col" id="alias">Alias</th>
				</thead>
				<tbody
					id="table-nodes-body"
					class="cursor-pointer"
					hx-get="/api/lightning/nodes"
					hx-trigger="load"
					hx-target="this"
					hx-swap="innerHTML"
					hx-on="htmx:afterSwap: enrichRgaaTableRows(this, ['id', 'alias'])">

					<tr>
						<td colspan="2">Chargement en cours...</td>
					</tr>
				</tbody>
			</table>

		</section>


		<!-- Info -->
		<section id="info" style="display: none;" class="mt-6 mx-6 w-100 bg-base-100 p-4 rounded-box shadow-md node-event-container">
			<h2 class="text-xl text-center font-semibold mb-2">âš¡ï¸ Informations about your node âš¡ï¸</h2>
			<div
				id="node-data"
				class="node-event"
				hx-get="/api/lightning/nodeInfo"
				hx-vals=""
				hx-trigger="nodeSelected"
				hx-target="this"
				hx-swap="innerHTML"
				hx-on="htmx:afterSwap: updateNodeData()">
			</div>

			<div id="node-section" class="node-info" style="border-left: 4px solid #3399ff; padding-left: 1em;">
				<p id="alias-display" class="flex items-center gap-2 p-[5px]">
					Alias : <span id="alias-value"></span>
					<button onclick="enableEdit()" class="text-sm" aria-label="Edit" title="edit">âœï¸</button>
				</p>

				<form hx-put="/api/lightning/nodeInfo" id="edit-form" hx-swap="none" style="display: none;align-items: center;">
					<input type="text" name="alias" id="alias-input" class="border w-[24ch] px-2 py-1 rounded" />
					<input type="color" name="color" id="color-input" class="ml-2 w-6" />
					<button type="submit" class="ml-2 text-sm" aria-label="Save" title="Save">ğŸ’¾</button>
					<button type="button" onclick="cancelEdit()" class="ml-1 text-sm" aria-label="Cancel" title="Cancel">âŒ</button>
				</form>
			</div>
		</section>

	</div>
	<div style="flex-direction:column">

		<!-- URI -->
		<section style="display:none;" class="mt-6 mx-6 w-100 bg-base-100 p-4 rounded-box shadow-md node-event-container">
			<h2 class="text-xl text-center font-semibold mb-2">âš¡ï¸ URI âš¡ï¸</h2>
			<p class="text-base text-gray-700 mb-4">You can share the url on your lightning node</p>
			<div
				class="node-event"
				hx-get="/api/lightning/uri"
				hx-vals=""
				hx-trigger="nodeSelected"
				hx-target="this"
				hx-swap="innerHTML">
			</div>
		</section>

		<!-- Pairs -->
		<section style="display:none;" class="mt-6 mx-6 w-100 bg-base-100 p-4 rounded-box shadow-md node-event-container">
			<h2 class="text-xl text-center font-semibold mb-2">âš¡ï¸ Pairs âš¡ï¸</h2>
			<p class="text-base text-gray-700 mb-4">Connect to a new peer (note : std P2P port : 9735 )</p>
			<form hx-post="/api/lightning/peer" hx-vals="" hx-swap="none" class="mt-2 node-event doReset">
				<label for="uri" class="text-base text-gray-700 mb-4">Add a pair</label>
				<input type="text" name="uri" id="uri" class="border px-2 py-1 rounded" />
				<button type="submit" class="ml-2 text-sm" aria-label="Connect" title="Connect">ğŸ”—</button>
			</form>
		</section>

	</div>

	<div style="flex-direction:column">
		<!-- Create Channel -->
		<section style="display:none;" class="mt-6 mx-6 w-100 bg-base-100 p-4 rounded-box shadow-md node-event-container">
			<h2 class="text-xl text-center font-semibold mb-2">âš¡ï¸ New Channel âš¡ï¸</h2>
			<p class="text-base text-gray-700 mb-4">ğŸš§ Soon a more friendly way to create a channel ğŸ—ï¸</p>
			<form hx-post="/api/lightning/channel" hx-vals="" hx-swap="none" class="mt-2 node-event doReset" style="display:flex; flex-direction:column">
				<label for="pubKey" class="text-base text-gray-700">Public Key</label>
				<input type="text" name="pubKey" id="pubKey" class="border px-2 py-1 rounded" />
				<label for="amount" class="text-base text-gray-700">Amount</label>
				<input type="number" name="amount" id="pubKey" class="border px-2 py-1 rounded" />
				<div class="text-center">
					<button type="submit" class="mt-2 border border-gray-300 p-1 rounded text-sm" aria-label="Create channel" title="Create channel">ğŸ› ï¸ âš¡ğŸ”—âš¡</button>
				</div>
			</form>
		</section>
	</div>
</div>
<script>

	/************************* Edit info ****************************/

	function updateNodeData() {
		const alias = document.querySelector("#node-data [data-alias]")?.dataset.alias;
		const color = document.querySelector("#node-data [data-color]")?.dataset.color;

		if (alias && color) {
			document.getElementById("alias-value").textContent = alias;
			document.getElementById("node-section").style.borderLeftColor = color;
			document.getElementById("alias-input").value = alias;
			document.getElementById("color-input").value = color;
		}
	}

	function enableEdit() {
		document.getElementById("alias-display").style.display = "none";
		document.getElementById("edit-form").style.display = "flex";
	}

	function cancelEdit() {
		document.getElementById("edit-form").style.display = "none";
		document.getElementById("alias-display").style.display = "flex";
	}

	/********************************* Event on th tab **************************************/

	document.querySelector("#table-nodes-body").addEventListener("click", function(e) {
		let tr = e.target.closest("tr");
		if (tr) {
			// css for the selected ligne
			document.querySelectorAll("tr").forEach(row => row.classList.remove("selected"));
			tr.classList.add("selected");

			// show the section info
			document.querySelectorAll(".node-event-container").forEach(el => {
				el.style.display = "block";
			});

			// trigger the loading of informations
			const nodeDataDiv = document.querySelectorAll(".node-event").forEach(el => {
				el.setAttribute("hx-vals", JSON.stringify({ id: tr.dataset.id }));
				el.dispatchEvent(new Event("nodeSelected"));
			});

		}
	});

	/*************************************** URI **********************************/

	function copyURI(uri) {
		if (!navigator.clipboard) {
			alert("Copy not supported on this browser.");
			return;
		}

		navigator.clipboard.writeText(uri)
		.then(() => {
			console.log("Copy !");
		})
		.catch(err => {
			console.error("Erreur de copie :", err);
			alert("Impossible to copy. Check the permissions or the browser.");
		});
	}

	/*************************************** URI **********************************/

	document.querySelectorAll("form.doReset").forEach(f => {
		f.addEventListener("nodeSelected", function(e) {
			this.reset()
		});
	});

</script>
